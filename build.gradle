plugins {
    id 'java-library'
    id 'com.avast.gradle.docker-compose' version '0.14.0'
    id 'jacoco'
}

ext {
    connidVersion = '1.5.0.17'
    polygonVersion = '3.0.1'
    connectorName = 'lu.lns.connector.odoo'
}

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

group 'lu.lns'
version '1.2.0.1'

configurations {
    includeInJar
    implementation.extendsFrom includeInJar
}

jar {
    from (configurations.includeInJar) {
        into "lib"
    }
    manifest {
        attributes(
                'ConnectorBundle-Version': "${archiveVersion.get()}",
                'ConnectorBundle-Name': "${connectorName}",
                'ConnectorBundle-FrameworkVersion': "${connidVersion}"
        )
    }
}

repositories {
    mavenCentral()
    maven {
        url "https://nexus.evolveum.com/nexus/content/repositories/releases"
    }
}

dependencies {
    implementation("net.tirasa.connid:connector-framework:${connidVersion}")

    includeInJar("com.evolveum.polygon:connector-common:${polygonVersion}") {
        exclude group: 'net.tirasa.connid', module: 'connector-framework'
    }

    includeInJar("org.apache.commons:commons-lang3:3.11")
    includeInJar("org.apache.xmlrpc:xmlrpc-client:3.1.3") {
        // already included in jdk 11 and is problem when interfaces loaded from this jar bundled with connector
        // and implementation comes from midpoint's jdk 11
        exclude group: 'xml-apis', module: 'xml-apis'
        // of course we don't need junit in production
        exclude group: 'junit', module: 'junit'
    }

    testImplementation("junit:junit:4.13.1")
    testImplementation("net.tirasa.connid:connector-framework-contract:${connidVersion}") // required by connId, e.g. encryption
}

test {
    finalizedBy jacocoTestReport // report is always generated after tests run
}

jacocoTestReport {
    dependsOn test // tests are required to run before generating the report
}

dockerCompose {
    useComposeFiles = ['docker/docker-compose-midpoint.yml']
    //captureContainersOutput = true // uncomment to see container output in std out
    captureContainersOutputToFiles = "${buildDir}/containers-logs/captured"
    removeContainers = false
    removeVolumes = false
}

task testInMidpoint {
    group 'verification'
    description 'Builds the connector JAR and uses docker-compose to start midpoint'
    outputs.upToDateWhen { false }

    doLast {
        logger.lifecycle("Waiting indefinitely until key + ENTER is pressed...")
        System.in.read()
        logger.lifecycle("Stopping...")
    }
}

dockerCompose.isRequiredBy(testInMidpoint)
composeUp.dependsOn jar
